### Курсовая работа по проектированию высоконагруженных систем
### _выполняет студент ИУ9-52Б Черников Артём_

## 1. Тема и целевая аудитория

## Сервис-аналог: Дзен

## Тип сервиса:
**Блог-платформа** для создания и просмотра контента (статьи, фото, видео).

## Функциональность MVP:
1. **Регистрация и авторизация пользователей**
2. **Публикация медиаконтента** (возможность загружать и публиковать статьи, фотографии, видео)
3. **Просмотр контента** (пользователи могут просматривать контент, найденный в поиске, на страницах других пользователей, среди рекомендованных публикаций, а также в избранном и истории просмотров)
4. **Подписки на пользователей** (возможность подписываться на интересующих пользователя авторов)
5. **Комментирование** (написание комментариев к публикациям и другим комментариям)

## Навигация:
- **Главная страница** (персонализированная лента с рекомендованными публикациями на основе интересов пользователя)
- **Подписки** (список авторов, на которых подписан пользователь)
- **Популярное** (публикации с наибольшим количеством просмотров за последнюю неделю)
- **Избранное** (список публикаций, отмеченных пользователем как избранные)
- **История** (список уже просмотренных пользователем публикаций)
- **Профиль** (раздел с информацией о пользователе и возможностью изменения некоторых данных)
- **Видео** (лента с видеоконтентом, подобранная на основе интересов пользователя)
- **Поиск** (поиск по всему контенту сервиса с возможностью фильтрации по тексту, заголовкам и популярным хештегам)

## Аудитория[^2]:
Платформой пользуются люди **от 12 до 80 лет**, при этом основная аудитория (**25-44 года**) составляет более половины пользователей. **60% пользователей** – женщины. Сервис посещают **80 млн человек ежемесячно** и **31,8 млн ежедневно**, причем **90% трафика** поступает из России и стран СНГ. **56% пользователей** заходят на платформу со смартфонов.

## Ключевые продуктовые решения:
- **Алгоритм подбора рекомендаций** на основе интересов пользователя (по хештегам, сервисным тегам)
- **Монетизация контента**
- **Возможность правки публикаций LLM**
- **Хештеги** (использование хештегов для классификации и поиска контента)
- **Шортсы** (короткие видео)

---

## 2. Расчет нагрузки
MAU: **80 млн**  
DAU: **31,8 млн**[^1]

### 2.1 Расчёт хранилища под одного пользователя
Средний размер хранилища личных данных пользователя с каналом: 
1.	Аватар – в сжатом виде до 300 КБ
2.	Настройки – 2 КБ (данные пользователя: возраст, пол; уведомления, контакты, настройки)
3.	Данные для системы рекомендаций публикаций - до 200 КБ 
### _как это считалось - чуть ниже_
### Средний размер хранилища пользователя с каналом:

| Данные              | Размер контента                      |
|---------------------|--------------------------------------|
| Аватар              | 300 КБ                                 |
| Настройки           | 2 КБ (данные пользователя: возраст, пол, уведомления, контакты, настройки) |
| Данные для рекомендательной системы| 200 Кб|

### общая таблица с размером хранилища
| Тип контента      | Средний общий объём на автора  |
|-------------------|--------------------------------|
| Видео             | 80 ГБ                          | 
| Статьи и посты    | 2,35 ГБ                        | 
| Личные данные     | 0,5 МБ                         |
| **Итого**         | 82,35 ГБ                       |

### 2.1a Видео

В 2023 году было загружено:
- **5 000 000 коротких видео**.
- **6 000 000 длинных видео**.
- Количество авторов видео: **500 000**[^2].

В среднем на каждого активного автора приходится:
- **10 коротких видео** (5 000 000 / 500 000).
- **12 длинных видео** (6 000 000 / 500 000).

Исходя из данных о размерах видео - расчёт [тут](#Расчёт-размера-видео):
- Короткие видео (до 2 минут, но для расчёта 1:45) — **5 МБ**.
- Длинные видео (до 8 часов, но возьмём для расчёта 4 часа) — **4,5 ГБ**.

### Расчёт объёма хранилища на одного автора:
- **Короткие видео**: 10 видео * 78,5 МБ = **785 МБ**.
- **Длинные видео**: 12 видео * 11,7 ГБ = **140,4 ГБ**.

Итого на одного активного автора в 2023 выделяется **~141 ГБ** хранилища для видео. Посчитаем теперь за все годы, но для начала рассмотрим изменение количества авторов.

### Количество авторов по годам:

Количество активных авторов (тех, кто загружает видео) изменялось с годами. Примерно по следующим данным:
- **2019 год**: **70 000** авторов.
- **2020 год**: **100 000** авторов (из них **45 000** регулярно публиковали в неделю)[^3].
- **2021 год**: **200 000** авторов (из них **50 000** регулярно публиковали в неделю)[^4].
- **2022 год**: **400 000** авторов (из них **100 000** регулярно публиковали в неделю)[^5].
- **2023 год**: **500 000** авторов[^2].

### Объём хранилища на одного автора за каждый год

Расчёт объёма хранилища на одного активного автора в зависимости от года:
- **2019 год**: **5 ГБ/автора в год**.
- **2020 год**: **18 ГБ/автора в год**.
- **2021 год**: **90 ГБ/автора в год** (рост в 5 раз по сравнению с 2020 годом)[^4].
- **2022 год**: **101 ГБ/автора в год** 
- **2023 год**: **141 ГБ/автора в год**.  (увеличение на 40% по сравнению с 2022 годом)[^5].
- **2024 год**: **170 ГБ/автор в год** (прогноз, в связи с невозможностью просмотра/выгрузки видео на YouTube, пользователи переходят на альтернативные контент-площадки)

Итого для старого пользователя(публикующим видео с 3 квартала 2019 года), который был активен все годы: **355 ГБ**.  
Для новых пользователей, которые начали загружать видео только в 2023 году, требуется **141 ГБ**.  
Учитывая прирост активных авторов по годам, можно рассчитать, что средний объём хранилища, выделенный на одного активного автора, составляет **около 300 ГБ**. С учётом текущего года нужно рассчитывать на дополнительный объём видео в **170 ГБ**, загруженного пользователем. То есть, общий объём видео, загруженного среднестатистическим автором, публикующего видеоконтент, составит около **470 ГБ** 

### Расчёт размера видео

#### Расчёты для короткого видео (1 минута 45 секунд)

| Разрешение | Битрейт (Мбит/с) | Объём до сжатия (МБ) | Объём после сжатия (МБ) |
|------------|------------------|----------------------|-------------------------|
| 1080p      | 5                | 65                   | 33                      |
| 720p       | 3                | 39                   | 20                      |
| 480p       | 2                | 26                   | 10                      |
| 360p       | 1.5              | 20                   | 7.5                     |
| 240p       | 1                | 13                   | 5                       |
| 160p       | 0.5              | 6                    | 3                       |

_Итого общий вес всех разрешений короткого видео_ : **78,5 МБ**

#### Расчёты для длинного видео (4 часа)

| Разрешение | Битрейт (Мбит/с) | Объём до сжатия (ГБ) | Объём после сжатия (ГБ) |
|------------|------------------|----------------------|-------------------------|
| 1080p      | 5                | 9                    | 4.5                     |
| 720p       | 3                | 5.4                  | 2.7                     |
| 480p       | 2                | 3.6                  | 1.8                     |
| 360p       | 1.5              | 2.7                  | 1.35                    |
| 240p       | 1                | 1.8                  | 0.9                     |
| 160p       | 0.5              | 0.9                  | 0.45                    |

_Итого общий вес всех разрешений длинного видео_ : **11,7 ГБ**

### Примечания для расчётов:
- **Трафик и вес на сервере** рассчитываются по стандартной формуле:  
 _Объём = Битрейт (Мбит/с) × (Длительность видео (с) × (1 Мбит/8)) / 1024_

  для получения результата в МБ/ГБ.
- **Сжатие**: учитывает снижение объёма в 2 раза.


_таблица для хранилища одного пользователя, публикующего видео_


| Год      | Количество активных авторов | Объём хранилища на одного автора, ГБ | Общий объём хранилища, ТБ |
|----------|-----------------------------|--------------------------------------|---------------------------|
| 2019     | 70 000                      | 5 ГБ                                | 350                       |
| 2020     | 100 000                     | 18 ГБ                               | 1 800                     |
| 2021     | 200 000                     | 90 ГБ                               | 18 000                    |
| 2022     | 400 000                     | 101 ГБ                              | 40 400                    |
| 2023     | 500 000                     | 141 ГБ                              | 70 500                    |
| 2024 (прогноз) | 600 000               | 170 ГБ                              | 102 000                   |
| **Итого**| **-**                       | **Средний объём: ~300 ГБ/автор**     | **233 050 ТБ**             |

Средний объём хранилища на одного активного автора — **~300 ГБ**, а общий объём хранилища к 2024 году (с учётом роста количества авторов и увеличения размера данных) составит **233 050 ТБ**.

## 2.1b Расчёт хранилища под одного пользователя для статей

### 1. Данные о статьях

В 2023 году было опубликовано:
- **20 000 000 постов**[^2].
- **14 000 000 статей**.
- Количество авторов: **700 000**.

Значит, в среднем на каждого этого автора приходится:
- **29 постов**.
- **20 статей**.
Эти данные будем считать константыми и для других годов, ведь активность авторов особо не меняется.

### Сколько весит 1 статья:
Т.к 1 символ в кодировке UTF-8 весит 1 байта, а средний размер статьи на Дзен 3000-5000 знаков с учётом пробелов (личный опыт), то средний вес статьи: 4000/1000 = 4 КБ.

1. **Текст** — **4 КБ**.
2. **Данные статьи** (метаданные, хештеги и прочее) — **1 КБ**.
3. **Картинки**: 
   - В статье в среднем **5 картинок**.
   - Средний вес картинки — **500 КБ**.
   - Итого: **5 картинок * 0,5 МБ = 2,5 МБ**.
   - После сжатия: **~2,5 МБ** на статью.

### Итого расчёт объёма хранилища для статьи:

- **Текст и данные**: 4 КБ + 1 КБ = **5 КБ**.
- **Картинки** (с учётом сжатия): **2,5 МБ**.

Итого, одна статья занимает **~2,5 МБ** хранилища.

### Сколько весит пост

1. **Текст** — **1 КБ**.
2. **Данные** — **1 КБ**.
3. **Картинка** (с учётом сжатия): **0,5 МБ**.

### Итого расчёт объёма хранилища для поста:
- **Текст и данные**: 1 КБ + 1 КБ = **2 КБ**.
- **Картинка**: **0,5 МБ**.

Итого, один пост занимает **~500 КБ**.

## Объём хранилища на одного пользователя на один год

На одного пользователя приходится:
- **29 постов** * **500 КБ** = **~14,5 МБ** для постов.
- **20 статей** * **2500 КБ** = **~50 МБ** для статей.

_таблица годового хранилища среднестатистического пользователя, публикующего статьи_

| Тип контента      | Количество на автора в год | Размер одного контента | Общий объём на автора в год | Общий объём на автора за 9 лет |
|-------------------|---------------------------|------------------------|----------------------------|--------------------------------|
| Посты             | 29                        | 0,5 МБ                 | 14,5 МБ                    | 130,5 МБ                       |
| Статьи            | 20                        | 2,5 МБ                  | 50 МБ                     | 450 МБ                         |
| **Итого**         | **-**                     | **-**                  | **64,5 МБ**               | **580,5 МБ**                    |



Итого на одного пользователя в год выделяется **~64,5 МБ** хранилища для контента (статей и постов) в год. Значит, с момента существования сервиса, у самого старого юзера будет 9 лет * 64,5 МБ занимаемое хранилище, то есть, **580,5 МБ**. Но это самый предельный усреднённый вариант, ведь большая часть авторов у Дзена появилась с 2021 по 2023 года. Значит, для расчёта возьмём с 2021 года: 3 * 64,5 = **193,5 МБ** в среднем занимает хранилище одного автора статей сейчас. С учётом 2024 года оно будет составлять **258 МБ**

Значит, на хранение статей всех авторов с учтом надо выделить 180600 ГБ = **180,6 ТБ**

Подводим итог вычислений: на хранение всех данных пользователей на сервере надо выделить: 233 050 ТБ + 180,6 ТБ = ~234 000 ТБ = **234 ПБ**

## Технические метрики:
В отчёте Дзена за 2021 год указано, что суммарно пользователи смотрели контент ~580 млн минут в день, на тот момент DAU был равен 22 млн => 26 минут в день проводят в среднем в Дзене, и этот показатель не сильно поменялся до 2024.
### Действия пользователей:

| Действие                         | Частота действий на пользователя в день  |
|-----------------------------------|------------------------------------------|
| Регистрация и авторизация         | 0,033 раза (1 раз в месяц)               |
| Публикация медиаконтента          | 0,13 раза[^1]                               |
| Просмотр контента                 | 4 раза для статей, 20 раз для коротких видео |
| Подписки на пользователей, лайки, репосты, добавление в избранное         | 5 раз                                   |
| Комментирование                   | 0,015 раз[^2]                               |
| Просмотр главной страницы                    | 1 раз               |
| Просмотр популярного                    | 0.5 раза                |
| Поиск                  | 0,2 раза           | 
| Избранное                  | 0,2 раза                |
| Видео (старница)                  | 1раз               |


### RPS (Requests Per Second) на основные действия:

| Действие                         | Формула                                | RPS   |
|-----------------------------------|----------------------------------------|-------|
| Регистрация и авторизация         | 0,033 * 32 000 000                     | 12    |
| Публикация медиаконтента          | 0,13 * 32 000 000 / 86 400             | 48    |
| Просмотр контента (статьи)        | 4 * 32 000 000 / 86 400                | 1 480 |
| Просмотр контента (видео)         | 20 * 32 000 000 / 86 400               | 7 407 |
| Подписки на пользователей, лайки, репосты, добавление в избранное          | 5 * 32 000 000 / 86 400                | 1850   |
| Комментирование                   | 0,015 * 32 000 000 / 86 400            | 5     |
| Просмотр главной страницы                    | 1 * 32 000 000 / 86 400                | 370 |
| Просмотр популярного                    | 0.5 * 32 000 000 / 86 400                | 185 |
| Поиск                  | 0,2 * 32 000 000 / 86 400                | 74 |
| Избранное                  | 0,2 * 32 000 000 / 86 400                | 74 |
| Видео (старница)                  | 1 * 32 000 000 / 86 400                | 370 |

### Сетевой трафик
Рассчитаем сначала суммарный суточный для видео: учитывая, что MAU = 32млн, а пользователи суммарно проводят в Дзене 840млн минут, из которых 337 - это видео, и зная средний битрейт большого видео (3Мбит/с) и короткого (0,5Мбит/с), то предположим, что за день польователь 1/3 своего времени тратит на длинные видео, а 2/3 на короткие. Итого можно подсчитать общий сетевой трафик в сутки: 337млн минут * (1/3 * 3 + 2/3 * 0,5) * 60 /1000 = ~27 000 000 Гбит/день = 3375000 ГБайт = **3,4 ПБ суммарный сетевой трафик на видео** 

Из этих данных посчитаем средний трафик на просмотр видео: 14 400 000/(24*60*60) = 312,5 Гбит/с
Загрузка контента в несколько десятков раз отличается от просмотра контента, поэтому средний трафик загрузка видео пользователем будем считать 10 Гбит/с
Загрузка статей: 4 статьи * 19,5 млн человек, кто читает статьи * вес одной статьи 2,5МБ / (24*60*60) = 2,5 ГБит/с

#### Обычный (340 Гбит/с):

| Действие                         | Скорость трафика                       |
|-----------------------------------|----------------------------------------|
| Загрузка видео пользователем      | 10 Гбит/с                              |
| Просмотр видео                    | 312,5 Гбит/с                              |
| Загрузка и подбор рекламы         | 10 Гбит/с                              |
| Загрузка статей                   | 3 Гбит/с                               |
| Загрузка превью статей и видео    | 2 Гбит/с                               |

Пиковый = 166,7 * коэффициент 2,5 = ~416 Гбит/с на видео, примерно с таким же коэффициентом рассчитаем нагрузку на другие функциональности:

#### Пиковый (740 Гбит/с) [информация частично подтверждена CTO Дзена](https://t.me/kondra2lp):
| Действие                         | Скорость трафика                       |
|-----------------------------------|----------------------------------------|
| Загрузка видео пользователем      | 15 Гбит/с                              |
| Просмотр видео                    | 700 Гбит/с                              |
| Загрузка и подбор рекламы         | 20 Гбит/с                              |
| Загрузка статей                   | 8 Гбит/с                               |
| Загрузка превью статей и видео    | 6 Гбит/с                              |


## Источники:
[^1]: [Отчёт ВК за первый квартал 2024 года](https://corp.vkcdn.ru/media/files/RUS_Press_Release_Q1_2024.pdf)
[^2]: [Итоги 2023 года социальной сети Дзен](https://dzen.ru/a/ZYWi7bChZQJnLS9d)
[^3]: [Итоги 2020 года социальной сети Яндекс.Дзен](https://themedia.center/yandex-zen-2020/)
[^4]: [Итоги 2021 года социальной сети Яндекс.Дзен](https://yandex.ru/company/news/2021-12-27)
[^5]: [Итоги 2021 года социальной сети Яндекс.Дзен](https://www.cnews.ru/news/line/2022-12-23_dzen_podvel_itogi_2022_goda)
[^6]: [Доклад Ивана Емельянова на Highload 2022](https://highload.ru/moscow/2022/abstracts/9570)
[^7]: [Статистика Дзена №1](https://inclient.ru/dzen-stats/)
[^8]: [Статистика Дзена №1](https://alente.ru/blog/yandeksdzen-kak-platforma-dlya-formirovaniya-interesa-k-produktuusluge)

## 3. Глобальная балансировка нагрузки
---
### Разбиение по доменам
Разбиение на поддомены позволяет управлять микросервисами и управлять нагрузкой и производительностью.
- www.dzen.ru: Основной веб-домен для публичного доступа к сервису Дзена. Представляет собой основной пользовательский интерфейс, через который пользователи взаимодействуют с платформой. Он координирует взаимодействие с поддоменами. 
- m.dzen.ru: мобильная версия сайта. Этот поддомен специально оптимизирован для работы на мобильных устройствах.
- log.dzen.ru: обработка логов. Это может включать данные о работе сервиса, действиях пользователей и мониторинг систем. Он необходимы для аналитики и отладки системы.  
- passport.dzen.ru: Поддомен для аутентификации пользователей, отвечает за вход в систему и управление профилем пользователя.  
- clck.dzen.ru: сервис отслеживания переходов по ссылкам. Он помогает анализировать активность пользователей и строить метрики по кликам.  
- cdn.dzen.ru: Используется для доставки статического контента (CSS, JavaScript, изображения, видео) через сеть CDN, что улучшает скорость загрузки сайта не только по России, но и по всему миру.
- suggest.dzen.ru: Отвечает за систему рекомендаций, которую Дзен использует для персонализации контента - автодополнение запросов, персональные рекомендации на основе предыдущей активности пользователя.   

### Расположение датацентров:
Соцсетью Дзен пользуются каждый месяц 80 млн человек, 90% из них это жители России. 
| География     | Процент |
|---------------|---------|
| Москва, СПБ   | 34%     |
| Города > 1 млн| 25%     |
| > 500к        | 11%     |
| Другие        | 30%     |

Как видим, 34% пользователей из Москвы и Санкт-Петербурга и ещё 25% из других городов-милионников. Было бы логично поставить основные датацентры в Москве и Санкт-Петербурге, Красноярске и Владивостоке - это позволит сделать latency небольшим для все регионов страны. 
### DNS балансировка:
Так как к одному доменному имени будет привязано несколько ip-адресов, то на этом уровне глобальной балансировки будем отдавать разный ip-адрес датацентра ещё на уровне резолвинга доменного имени. При балансировке на уровне DNS используется алгоритм Weighted Round Robin - это циклическая очередь распределения запросов, но более мощныцй сервер получает большее количество запросов. Такой способ балансировки очень удобен, так как выданный на этом этапе ip-адрес датацентра зранится днями, и не нужно иметь большое количество DNS серверов. 
### Anycast балансировка:
BGP Anycast балансировка будет особенно полезна пользователям из северных регионов России. Например, из Воркуты расстояние до датацентров Москвы и Красноярска примерно одинаковое. И чтобы решить, куда лучше направить пользователя, используем Anycast: датацентрам присваивается единый IP, и при запросе пользователя протокол маршрутизации BGP принимает решение, куда его направить (например, в Москву или Красноярск), исходя из количества "хопов". В случае перегрузки или отказа этого сервера, запроса передаётся следующему по числу хопов. 


