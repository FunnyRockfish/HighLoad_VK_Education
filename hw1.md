### Курсовая работа по проектированию высоконагруженных систем
### _выполняет студент ИУ9-52Б Черников Артём_

## 1. Тема и целевая аудитория

## Сервис-аналог: Дзен

## Тип сервиса:
**Блог-платформа** для создания и просмотра контента (статьи, фото, видео).

## Функциональность MVP:
1. **Регистрация и авторизация пользователей**
2. **Публикация медиаконтента** (возможность загружать и публиковать статьи, фотографии, видео)
3. **Просмотр контента** (пользователи могут просматривать контент, найденный в поиске, на страницах других пользователей, среди рекомендованных публикаций, а также в избранном и истории просмотров)
4. **Подписки на пользователей** (возможность подписываться на интересующих пользователя авторов)
5. **Комментирование** (написание комментариев к публикациям и другим комментариям)

## Навигация:
- **Главная страница** (персонализированная лента с рекомендованными публикациями на основе интересов пользователя)
- **Подписки** (список авторов, на которых подписан пользователь)
- **Популярное** (публикации с наибольшим количеством просмотров за последнюю неделю)
- **Избранное** (список публикаций, отмеченных пользователем как избранные)
- **История** (список уже просмотренных пользователем публикаций)
- **Профиль** (раздел с информацией о пользователе и возможностью изменения некоторых данных)
- **Видео** (лента с видеоконтентом, подобранная на основе интересов пользователя)
- **Поиск** (поиск по всему контенту сервиса с возможностью фильтрации по тексту, заголовкам и популярным хештегам)

## Аудитория[^2]:
Платформой пользуются люди **от 12 до 80 лет**, при этом основная аудитория (**25-44 года**) составляет более половины пользователей. **60% пользователей** – женщины. Сервис посещают **80 млн человек ежемесячно** и **31,8 млн ежедневно**, причем **90% трафика** поступает из России и стран СНГ. **56% пользователей** заходят на платформу со смартфонов.

## Ключевые продуктовые решения:
- **Алгоритм подбора рекомендаций** на основе интересов пользователя (по хештегам, сервисным тегам)
- **Монетизация контента**
- **Возможность правки публикаций LLM**
- **Хештеги** (использование хештегов для классификации и поиска контента)
- **Шортсы** (короткие видео)

---

## 2. Расчет нагрузки
MAU: **80 млн**  
DAU: **31,8 млн**[^1]

### 2.1 Расчёт хранилища под одного пользователя
Средний размер хранилища личных данных пользователя с каналом: 
1.	Аватар – в сжатом виде до 300 КБ
2.	Настройки – 2 КБ (данные пользователя: возраст, пол; уведомления, контакты, настройки)
3.	Данные для системы рекомендаций публикаций - до 200 КБ 
### _как это считалось - чуть ниже_
### Средний размер хранилища пользователя с каналом:

| Данные              | Размер контента                      |
|---------------------|--------------------------------------|
| Аватар              | 300 КБ                                 |
| Настройки           | 2 КБ (данные пользователя: возраст, пол, уведомления, контакты, настройки) |
| Данные для рекомендательной системы| 200 Кб|

### общая таблица с размером хранилища
| Тип контента      | Средний общий объём на автора  |
|-------------------|--------------------------------|
| Видео             | 80 ГБ                          | 
| Статьи и посты    | 2,35 ГБ                        | 
| Личные данные     | 0,5 МБ                         |
| **Итого**         | 82,35 ГБ                       |

### 2.1a Видео

В 2023 году было загружено:
- **5 000 000 коротких видео**.
- **6 000 000 длинных видео**.
- Количество авторов видео: **500 000**[^2].

В среднем на каждого активного автора приходится:
- **10 коротких видео** (5 000 000 / 500 000).
- **12 длинных видео** (6 000 000 / 500 000).

Исходя из данных о размерах видео - расчёт [тут](#Расчёт-размера-видео):
- Короткие видео (до 2 минут, но для расчёта 1:45) — **5 МБ**.
- Длинные видео (до 8 часов, но возьмём для расчёта 4 часа) — **4,5 ГБ**.

### Расчёт объёма хранилища на одного автора:
- **Короткие видео**: 10 видео * 78,5 МБ = **785 МБ**.
- **Длинные видео**: 12 видео * 11,7 ГБ = **140,4 ГБ**.

Итого на одного активного автора в 2023 выделяется **~141 ГБ** хранилища для видео. Посчитаем теперь за все годы, но для начала рассмотрим изменение количества авторов.

### Количество авторов по годам:

Количество активных авторов (тех, кто загружает видео) изменялось с годами. Примерно по следующим данным:
- **2019 год**: **70 000** авторов.
- **2020 год**: **100 000** авторов (из них **45 000** регулярно публиковали в неделю)[^3].
- **2021 год**: **200 000** авторов (из них **50 000** регулярно публиковали в неделю)[^4].
- **2022 год**: **400 000** авторов (из них **100 000** регулярно публиковали в неделю)[^5].
- **2023 год**: **500 000** авторов[^2].

### Объём хранилища на одного автора за каждый год

Расчёт объёма хранилища на одного активного автора в зависимости от года:
- **2019 год**: **5 ГБ/автора в год**.
- **2020 год**: **18 ГБ/автора в год**.
- **2021 год**: **90 ГБ/автора в год** (рост в 5 раз по сравнению с 2020 годом)[^4].
- **2022 год**: **101 ГБ/автора в год** 
- **2023 год**: **141 ГБ/автора в год**.  (увеличение на 40% по сравнению с 2022 годом)[^5].
- **2024 год**: **170 ГБ/автор в год** (прогноз, в связи с невозможностью просмотра/выгрузки видео на YouTube, пользователи переходят на альтернативные контент-площадки)

Итого для старого пользователя(публикующим видео с 3 квартала 2019 года), который был активен все годы: **355 ГБ**.  
Для новых пользователей, которые начали загружать видео только в 2023 году, требуется **141 ГБ**.  
Учитывая прирост активных авторов по годам, можно рассчитать, что средний объём хранилища, выделенный на одного активного автора, составляет **около 300 ГБ**. С учётом текущего года нужно рассчитывать на дополнительный объём видео в **170 ГБ**, загруженного пользователем. То есть, общий объём видео, загруженного среднестатистическим автором, публикующего видеоконтент, составит около **470 ГБ** 

### Расчёт размера видео

#### Расчёты для короткого видео (1 минута 45 секунд)

| Разрешение | Битрейт (Мбит/с) | Объём до сжатия (МБ) | Объём после сжатия (МБ) |
|------------|------------------|----------------------|-------------------------|
| 1080p      | 5                | 65                   | 33                      |
| 720p       | 3                | 39                   | 20                      |
| 480p       | 2                | 26                   | 10                      |
| 360p       | 1.5              | 20                   | 7.5                     |
| 240p       | 1                | 13                   | 5                       |
| 160p       | 0.5              | 6                    | 3                       |

_Итого общий вес всех разрешений короткого видео_ : **78,5 МБ**

#### Расчёты для длинного видео (4 часа)

| Разрешение | Битрейт (Мбит/с) | Объём до сжатия (ГБ) | Объём после сжатия (ГБ) |
|------------|------------------|----------------------|-------------------------|
| 1080p      | 5                | 9                    | 4.5                     |
| 720p       | 3                | 5.4                  | 2.7                     |
| 480p       | 2                | 3.6                  | 1.8                     |
| 360p       | 1.5              | 2.7                  | 1.35                    |
| 240p       | 1                | 1.8                  | 0.9                     |
| 160p       | 0.5              | 0.9                  | 0.45                    |

_Итого общий вес всех разрешений длинного видео_ : **11,7 ГБ**

### Примечания для расчётов:
- **Трафик и вес на сервере** рассчитываются по стандартной формуле:  
 _Объём = Битрейт (Мбит/с) × (Длительность видео (с) × (1 Мбит/8)) / 1024_

  для получения результата в МБ/ГБ.
- **Сжатие**: учитывает снижение объёма в 2 раза.


_таблица для хранилища одного пользователя, публикующего видео_


| Год      | Количество активных авторов | Объём хранилища на одного автора, ГБ | Общий объём хранилища, ТБ |
|----------|-----------------------------|--------------------------------------|---------------------------|
| 2019     | 70 000                      | 5 ГБ                                | 350                       |
| 2020     | 100 000                     | 18 ГБ                               | 1 800                     |
| 2021     | 200 000                     | 90 ГБ                               | 18 000                    |
| 2022     | 400 000                     | 101 ГБ                              | 40 400                    |
| 2023     | 500 000                     | 141 ГБ                              | 70 500                    |
| 2024 (прогноз) | 600 000               | 170 ГБ                              | 102 000                   |
| **Итого**| **-**                       | **Средний объём: ~300 ГБ/автор**     | **233 050 ТБ**             |

Средний объём хранилища на одного активного автора — **~300 ГБ**, а общий объём хранилища к 2024 году (с учётом роста количества авторов и увеличения размера данных) составит **233 050 ТБ**.

## 2.1b Расчёт хранилища под одного пользователя для статей

### 1. Данные о статьях

В 2023 году было опубликовано:
- **20 000 000 постов**[^2].
- **14 000 000 статей**.
- Количество авторов: **700 000**.

Значит, в среднем на каждого этого автора приходится:
- **29 постов**.
- **20 статей**.
Эти данные будем считать константыми и для других годов, ведь активность авторов особо не меняется.

### Сколько весит 1 статья:
Т.к 1 символ в кодировке UTF-8 весит 1 байта, а средний размер статьи на Дзен 3000-5000 знаков с учётом пробелов (личный опыт), то средний вес статьи: 4000/1000 = 4 КБ.

1. **Текст** — **4 КБ**.
2. **Данные статьи** (метаданные, хештеги и прочее) — **1 КБ**.
3. **Картинки**: 
   - В статье в среднем **5 картинок**.
   - Средний вес картинки — **500 КБ**.
   - Итого: **5 картинок * 0,5 МБ = 2,5 МБ**.
   - После сжатия: **~2,5 МБ** на статью.

### Итого расчёт объёма хранилища для статьи:

- **Текст и данные**: 4 КБ + 1 КБ = **5 КБ**.
- **Картинки** (с учётом сжатия): **2,5 МБ**.

Итого, одна статья занимает **~2,5 МБ** хранилища.

### Сколько весит пост

1. **Текст** — **1 КБ**.
2. **Данные** — **1 КБ**.
3. **Картинка** (с учётом сжатия): **0,5 МБ**.

### Итого расчёт объёма хранилища для поста:
- **Текст и данные**: 1 КБ + 1 КБ = **2 КБ**.
- **Картинка**: **0,5 МБ**.

Итого, один пост занимает **~500 КБ**.

## Объём хранилища на одного пользователя на один год

На одного пользователя приходится:
- **29 постов** * **500 КБ** = **~14,5 МБ** для постов.
- **20 статей** * **2500 КБ** = **~50 МБ** для статей.

_таблица годового хранилища среднестатистического пользователя, публикующего статьи_

| Тип контента      | Количество на автора в год | Размер одного контента | Общий объём на автора в год | Общий объём на автора за 9 лет |
|-------------------|---------------------------|------------------------|----------------------------|--------------------------------|
| Посты             | 29                        | 0,5 МБ                 | 14,5 МБ                    | 130,5 МБ                       |
| Статьи            | 20                        | 2,5 МБ                  | 50 МБ                     | 450 МБ                         |
| **Итого**         | **-**                     | **-**                  | **64,5 МБ**               | **580,5 МБ**                    |



Итого на одного пользователя в год выделяется **~64,5 МБ** хранилища для контента (статей и постов) в год. Значит, с момента существования сервиса, у самого старого юзера будет 9 лет * 64,5 МБ занимаемое хранилище, то есть, **580,5 МБ**. Но это самый предельный усреднённый вариант, ведь большая часть авторов у Дзена появилась с 2021 по 2023 года. Значит, для расчёта возьмём с 2021 года: 3 * 64,5 = **193,5 МБ** в среднем занимает хранилище одного автора статей сейчас. С учётом 2024 года оно будет составлять **258 МБ**

Значит, на хранение статей всех авторов с учтом надо выделить 180600 ГБ = **180,6 ТБ**

Подводим итог вычислений: на хранение всех данных пользователей на сервере надо выделить: 233 050 ТБ + 180,6 ТБ = ~234 000 ТБ = **234 ПБ**

## Технические метрики:
В отчёте Дзена за 2021 год указано, что суммарно пользователи смотрели контент ~580 млн минут в день, на тот момент DAU был равен 22 млн => 26 минут в день проводят в среднем в Дзене, и этот показатель не сильно поменялся до 2024.
### Действия пользователей:

| Действие                         | Частота действий на пользователя в день  |
|-----------------------------------|------------------------------------------|
| Регистрация и авторизация         | 0,033 раза (1 раз в месяц)               |
| Публикация медиаконтента          | 0,13 раза[^1]                               |
| Просмотр контента                 | 4 раза для статей, 20 раз для коротких видео |
| Подписки на пользователей, лайки, репосты, добавление в избранное         | 5 раз                                   |
| Комментирование                   | 0,015 раз[^2]                               |
| Просмотр главной страницы                    | 1 раз               |
| Просмотр популярного                    | 0.5 раза                |
| Поиск                  | 0,2 раза           | 
| Избранное                  | 0,2 раза                |
| Видео (старница)                  | 1раз               |


### RPS (Requests Per Second) на основные действия:

| Действие                         | Формула                                | RPS   |
|-----------------------------------|----------------------------------------|-------|
| Регистрация и авторизация         | 0,033 * 32 000 000 / 86 400                     | 12    |
| Публикация медиаконтента          | 0,13 * 32 000 000 / 86 400             | 48    |
| Просмотр контента (статьи)        | 4 * 32 000 000 / 86 400                | 1 480 |
| Просмотр контента (видео)         | 20 * 32 000 000 / 86 400               | 7 407 |
| Подписки на пользователей, лайки, репосты, добавление в избранное          | 5 * 32 000 000 / 86 400                | 1850   |
| Комментирование                   | 0,015 * 32 000 000 / 86 400            | 5     |
| Просмотр главной страницы                    | 3 * 32 000 000 / 86 400                | 1010 |
| Просмотр популярного                    | 0.5 * 32 000 000 / 86 400                | 185 |
| Поиск                  | 0,4 * 32 000 000 / 86 400                | 150 |
| Избранное                  | 0,2 * 32 000 000 / 86 400                | 74 |
| Видео (старница)                  | 1 * 32 000 000 / 86 400                | 370 |
| Запрос рекламы |считаем как сумму запросов страниц, где показывается реклама: 1480+7407+370+185+370 |9812|

### Сетевой трафик
Рассчитаем сначала суммарный суточный для видео: учитывая, что MAU = 32млн, а пользователи суммарно проводят в Дзене 840млн минут, из которых 337 - это видео, и зная средний битрейт большого видео (3Мбит/с) и короткого (0,5Мбит/с), то предположим, что за день польователь 1/3 своего времени тратит на длинные видео, а 2/3 на короткие. Итого можно подсчитать общий сетевой трафик в сутки: 337млн минут * (1/3 * 3 + 2/3 * 0,5) * 60 /1000 = ~27 000 000 Гбит/день = 3375000 ГБайт = **3,4 ПБ суммарный сетевой трафик на видео** 

Из этих данных посчитаем средний трафик на просмотр видео: 14 400 000/(24*60*60) = 312,5 Гбит/с
Загрузка контента в несколько десятков раз отличается от просмотра контента, поэтому средний трафик загрузка видео пользователем будем считать 10 Гбит/с
Загрузка статей: 4 статьи * 19,5 млн человек, кто читает статьи * вес одной статьи 2,5МБ / (24*60*60) = 2,5 ГБит/с

#### Обычный (330 Гбит/с):

| Действие                         | Скорость трафика                       |
|-----------------------------------|----------------------------------------|
| Загрузка видео пользователем      | 10 Гбит/с                              |
| Просмотр видео                    | 312,5 Гбит/с                              |
| Загрузка статей                   | 3 Гбит/с                               |
| Загрузка и подбор рекламы         | 2 Гбит/с                              |
| Загрузка превью статей и видео    | 2 Гбит/с                               |

Пиковый = 166,7 * коэффициент 2,5 = ~416 Гбит/с на видео, примерно с таким же коэффициентом рассчитаем нагрузку на другие функциональности:

#### Пиковый (725 Гбит/с) [информация частично подтверждена CTO Дзена](https://t.me/kondra2lp):
| Действие                         | Скорость трафика                       |
|-----------------------------------|----------------------------------------|
| Загрузка видео пользователем      | 15 Гбит/с                              |
| Просмотр видео                    | 700 Гбит/с                              |
| Загрузка статей                   | 8 Гбит/с                               |
| Загрузка и подбор рекламы         | 5 Гбит/с                              |
| Загрузка превью статей и видео    | 6 Гбит/с                              |


## 3. Глобальная балансировка нагрузки
---
### Разбиение по доменам
Разбиение на поддомены позволяет управлять микросервисами и управлять нагрузкой и производительностью.
- www.dzen.ru: Основной веб-домен для публичного доступа к сервису Дзена. Представляет собой основной пользовательский интерфейс, через который пользователи взаимодействуют с платформой. Он координирует взаимодействие с поддоменами. 
- m.dzen.ru: мобильная версия сайта. Этот поддомен специально оптимизирован для работы на мобильных устройствах.
- log.dzen.ru: обработка логов. Это может включать данные о работе сервиса, действиях пользователей и мониторинг систем. Он необходимы для аналитики и отладки системы.  
- passport.dzen.ru: Поддомен для аутентификации пользователей, отвечает за вход в систему и управление профилем пользователя.  
- clck.dzen.ru: сервис отслеживания переходов по ссылкам. Он помогает анализировать активность пользователей и строить метрики по кликам.  
- cdn.dzen.ru: Используется для доставки статического контента (CSS, JavaScript, изображения, видео) через сеть CDN, что улучшает скорость загрузки сайта не только по России, но и по всему миру.
- suggest.dzen.ru: Отвечает за систему рекомендаций, которую Дзен использует для персонализации контента - автодополнение запросов, персональные рекомендации на основе предыдущей активности пользователя.[^9]   
[Схема поддоменов Дзена](domains_of_dzen.png)


### Расположение датацентров:
Соцсетью Дзен пользуются каждый месяц 80 млн человек, 90% из них это жители России. [^7]
| География     | Процент |
|---------------|---------|
| Москва, СПБ   | 34%     |
| Города > 1 млн| 25%     |
| > 500к        | 11%     |
| Другие        | 30%     |



Как видим, 34% пользователей из Москвы и Санкт-Петербурга и ещё 25% из других городов-милионников. Было бы логично поставить основные датацентры в Москве и Санкт-Петербурге, Красноярске и Владивостоке - это позволит сделать latency небольшим для все регионов страны. 

### DNS балансировка:
Так как к одному доменному имени будет привязано несколько ip-адресов, то на этом уровне глобальной балансировки будем отдавать разный ip-адрес датацентра ещё на уровне резолвинга доменного имени. При балансировке на уровне DNS используется алгоритм Latency-based Load Balancing - это распределение запросов по датацентрам в зависимости от задержки времени ответа сервера, то есть от latency. Такой способ балансировки очень удобен, так как выданный на этом этапе ip-адрес датацентра хранится днями, и не нужно иметь большое количество DNS серверов. 

### CDN:
Так как Дзен - это социальная сеть для обмена контентом, которого в ней на данный момент очень много, необходимо использование **_CDN_** для его доставки клиенту. CDN - Content Delivery Network, его суть заключается в кэшировании на EDGE-серверах. Пользователю будет возвращён статический контент (изображения, видео, стили CSS, JavaScript) с ближайщего к нему EDGE-сервера, если его кэш там есть. Этот подход помогает снизить latency и нагрузку на основные сервера. Также это помогает быстрой загрузке контента у пользователей по всему миру. 

## 4. Локальная балансировка нагрузки
---
## Локальная балансировка сервиса ДЗЕН

В этом разделе рассмотрим локальную балансировку сервиса ДЗЕН. Для начала приведу схему локальной балансировки:

![Локальная балансировка](локальная_балансировка.jpeg)

### А теперь про каждый уровень поподробнее:

### L4 (транспортный уровень модели OSI)[^10]:
Я выбрал метод **Virtual Server via IP Tunneling**, потому что он решает основные проблемы перегрузки балансировщика трафиком и по CPU и при этом не требует использования широковещательных ethernet-сегментов. Его основные преимущества в том, что он инкапсулирует оригинальные запросы в новые IP-пакеты и передаёт их на серверы, которые имеют локальный интерфейс с одинаковым VIP балансировщика. Сервер, в свою очередь, отправляет ответ уже сразу клиенту.

### VRRP (Virtual Router Redundancy Protocol):
Используется для отказоустойчивости балансировщиков. Заключается в том, что несколько балансировщиков объединяются в виртуальную группу, и один становится master, а остальные — backup. Если главный выходит из строя, то один из резервных берёт на себя его функции и становится master.

Тогда встаёт вопрос, как понять, что сервер вышел из строя — будем проверять работоспособность с помощью HTTP/HTTPS запросов. Такой **health check** может точно убедиться, что не только сервер, но и приложение на нём работают.

### L7 (прикладной уровень):
На уровне L7 балансировки используется **HTTP Reverse Proxy**. Могут использоваться разные реализации (например, HAProxy весьма популярен), но я выбрал именно **Nginx**, потому что он является многофункциональным и распространённым.

Реверс-прокси максимально упрощает управление запросами и выполняет:

1. Объединение TCP-соединений (поддерживает постоянные соединения с серверами, уменьшая количество соединений, которое требуется для обработки от каждого клиента).
2. Сохранение сессий (чтобы запросы от одного клиента всегда попадали на один и тот же сервер).
3. Кеширование (чтобы не отправлять постоянно каждый запрос на сервер, можно что-то сохранять на сервере прокси).
4. SSL Termination (расшифровка HTTPS на прокси, а на сервер шлём уже HTTP запросы).

На данном уровне будем использовать алгоритмы в зависимости от типа запроса — **Round Robin** или **Least Connection** (особенно хорош для блокирующего софта с длинным ответом на запросы).

### Kubernetes:
Мы будем использовать систему оркестрации **Kubernetes**, чтобы не запускать экземпляры приложения вручную на серверах (bare metal). Kubernetes берет на себя **service discovery** — управляет сервисами и динамически отслеживает список активных экземпляров с помощью механизма **Service** и **Endpoints**[^11].

Kubernetes добавляет экземпляр в реестр после успешного прохождения **readiness-пробы**, что подтверждает его готовность принимать трафик. Он также распределяет поды (экземпляры) по узлам, перезапускает их или перераспределяет при сбоях. Кроме того, Kubernetes автоматически выполняет масштабирование с помощью **auto-scaling**, таких как **Horizontal Pod Autoscaler (HPA)**, который регулирует количество подов в зависимости от нагрузки.


## 5. Логическая схема базы данных
---
## Иллюстрация:  
![Blank diagram(2)](https://github.com/user-attachments/assets/a7d4fe9f-768b-4cbe-b19d-4690623935a2)

## Описание таблиц, размеры и консистентность:  

---

### **Таблица: `video`** 
| Атрибут        | Тип данных  | Размер, байт |
|----------------|-------------|--------------|
| video_id       | string      | 16           |
| channel_id     | string      | 16           |
| author_id      | string      | 16           |
| title          | string      | до 100       |
| description    | string      | до 5000      |
| duration       | int         | 4            |
| formats        | JSON        | до 100       |
| created_at     | datetime    | 8            |
| status         | string      | 16           |
| 18_flag        | bool        | 1            |
| service_tags   | JSON        | до 256       |
| metadata       | JSON        | до 256       |

**Размер записи**: ~5 КБ, всего видео: ~50 млн, общий вес: **250 ГБ**  
**Нагрузка**: чтение: 14000 RPS, запись: 1480 RPS  

---

### **Таблица: `article`** 
| Атрибут      | Тип данных  | Размер, байт |
|--------------|-------------|--------------|
| article_id   | string      | 16           |
| channel_id   | string      | 16           |
| author_id    | string      | 16           |
| title        | string      | до 128       |
| text         | string      | до 1500      |
| tags         | JSON        | до 100       |
| published_at | datetime    | 8            |
| 18_flag      | bool        | 1            |
| images       | JSON        | до 600       |
| service_tags | JSON        | до 256       |
| metadata     | JSON        | до 256       |

**Размер записи**: ~2 КБ, всего статей: ~200 млн, общий вес: **400 ГБ**  
**Нагрузка**: чтение: 2800 RPS, запись: 28 RPS  

---

### **Таблица: `content_comments`**
| Атрибут     | Тип данных  | Размер, байт |
|-------------|-------------|--------------|
| comment_id  | string      | 16           |
| content_id  | string      | 16           |
| content_path | string     | 64           |
| answered_to | string      | 16 (nullable) |
| likes_count | int         | 4            |
| status      | string      | 16           |

**Размер записи**: ~72 Б, всего комментариев: ~300 млн, общий вес: **21 ГБ**  
**Нагрузка**: чтение: 1480 RPS, запись: 3 RPS  

---

### **Таблица: `user`**
| Атрибут         | Тип данных  | Размер, байт |
|-----------------|-------------|--------------|
| user_id         | string      | 16           |
| name            | string      | до 64        |
| surname         | string      | до 64        |
| gender          | string      | 1            |
| born_at         | datetime    | 8            |
| registered_at   | datetime    | 8            |
| nickname        | string      | 32           |
| password_hash   | string      | 64           |
| avatar_path     | string      | 64           |
| email           | string      | до 300       |
| phone_number    | string      | до 12        |
| status          | string      | до 16        |

**Размер записи**: ~32 КБ, всего пользователей: ~100 млн, общий вес: **3,2 ТБ**  
**Нагрузка**: чтение: 15 RPS, запись: 12 RPS  

---

### **Таблица: `session`**
| Атрибут    | Тип данных  | Размер, байт |
|------------|-------------|--------------|
| session_id | string      | 16           |
| user_id    | string      | 16           |

**Размер записи**: ~32 Б, всего сессий: ~80 млн, общий вес: **2,5 ГБ**  
**Нагрузка**: чтение: 12500 RPS, запись: 6 RPS  

---

### **Таблица: `channel`**
| Атрибут            | Тип данных  | Размер, байт |
|--------------------|-------------|--------------|
| channel_id         | string      | 16           |
| subscribers_number | int         | 4            |
| title              | string      | до 140       |
| description        | string      | до 200       |
| site_href          | string      | до 64        |
| email              | string      | до 300       |
| blocked_flag       | bool        | 1            |
| 18_flag            | bool        | 1            |
| created_at         | datetime    | 8            |

**Размер записи**: ~588 Б, всего каналов: ~100 млн, общий вес: **58 ГБ**  
**Нагрузка**: чтение: 2000 RPS, запись: 12 RPS  

---

### **Таблица: `channel_subscriber`**
| Атрибут   | Тип данных  | Размер, байт |
|-----------|-------------|--------------|
| chat_id   | string      | 16           |
| user_id   | string      | 16           |

**Размер записи**: ~32 Б, всего подписок: ~800 млн, общий вес: **25 ГБ**  
**Нагрузка**: чтение: 2000 RPS, запись: 10 RPS  

---

### **Таблица: `content_statistic`**
| Атрибут       | Тип данных  | Размер, байт |
|---------------|-------------|--------------|
| stat_id       | string      | 16           |
| item_type     | string      | 16           |
| item_id       | string      | 16           |
| likes_count   | int         | 4            |
| comment_count | int         | 4            |
| dislike_count | int         | 4            |
| views_count   | int         | 4            |

**Размер записи**: ~64 Б, всего записей: ~200 млн, общий вес: **12 ГБ**  
**Нагрузка**: чтение: 2000 RPS, запись: 2000 RPS  

---

### **Таблица: `user_statistic`**
| Атрибут     | Тип данных  | Размер, байт |
|-------------|-------------|--------------|
| statistic_id | string     | 16           |
| user_id      | string     | 16           |
| item_views   | JSON       | до 200       |

**Размер записи**: ~432 Б, всего записей: ~100 млн, общий вес: **43 ГБ**  
**Нагрузка**: чтение: 2000 RPS, запись: 12000 RPS  

---

### **Таблица: `favorite_item`**
| Атрибут     | Тип данных  | Размер, байт |
|-------------|-------------|--------------|
| favorite_id | string      | 16           |
| user_id     | string      | 16           |
| item_type   | string      | 16           |
| content_id  | string      | 16           |
| added_at    | datetime    | 8            |

**Размер записи**: ~72 Б, всего записей: ~500 млн, общий вес: **36 ГБ**  
**Нагрузка**: чтение: 1000 RPS, запись: 500 RPS  

---

### **Таблица: `search_logs`**
| Атрибут  | Тип данных  | Размер, байт |
|----------|-------------|--------------|
| user_id  | string      | 16           |
| query    | JSON        | до 32        |
| date     | datetime    | 8            |

**Размер записи**: ~48 Б, всего записей: ~80 млн, общий вес: **3,8 ГБ**  
**Нагрузка**: чтение: 150 RPS, запись: 150 RPS  

---

## 6. Физическая схема базы данных  
---
## Физическая схема базы данных:  
![Blank board(1)](https://github.com/user-attachments/assets/69230dc5-36fe-4ef2-99e9-1790d4bc91e9)


---  
## Таблица с описание таблиц:    

| **Таблица**             | **Описание**                                                                 | **БД**          | **Причина выбора**|
|-------------------------|-------------------------------------------------------------------------------|----------------|-------------------|
| `video`                 | Содержит информацию о видео (заголовок, описание, автор, форматы, метаданные). | **MongoDB**     |много атрибутов JSON, и|
| `article`               | Хранит статьи и связанные с ними данные (заголовок, текст, теги, изображения). | **MongoDB**     |
| `content_comments`      | Комментарии к контенту, включая ответы и статус комментария.                  | **ClickHouse**  |
| `user`                  | Данные пользователей (имя, email, аватар, статус и информация о регистрации).  | **PostgreSQL**  |
| `session`               | Сессии пользователей (для трекинга авторизаций).                              | **Redis** |
| `channel`               | Информация о каналах, включая описание и количество подписчиков.              | **PostgreSQL**  |
| `channel_subscriber`    | Связи между пользователями и каналами (подписки).                             | **PostgreSQL**  |
| `content_statistic`     | Статистика взаимодействий с контентом (лайки, просмотры, комментарии).        | **ClickHouse**  |
| `user_statistic`        | Статистика просмотров пользователя (история видео и статей).                  | **ClickHouse**  |
| `favorite_item`         | Избранные элементы пользователя (статьи и видео).                             | **PostgreSQL**  |
| `search_logs`           | Логи поиска пользователей.                                                    | **ClickHouse**  |

## Индексы:
 ### **Индексы таблиц**

Для оптимизации запросов и обеспечения высокой производительности в системе используются следующие индексы:

| **Таблица**            | **Индексы**                     |
|------------------------|----------------------------------|
| **`user`**             | `user_id`, `email`, `nickname`  |
| **`video`**            | `video_id`, `author_id`          |
| **`article`**          | `article_id`, `author_id`        |
| **`content_comments`** | `comment_id`                    |
| **`content_statistic`**| `item_id`                       |
| **`channel`**          | `channel_id`                    |
| **`search_logs`**      | `user_id`                       |

---

Эти индексы обеспечивают эффективное выполнение запросов, ускоряют поиск данных и минимизируют время отклика системы.
---
## Источники:
[^1]: [Отчёт ВК за первый квартал 2024 года](https://corp.vkcdn.ru/media/files/RUS_Press_Release_Q1_2024.pdf)
[^2]: [Итоги 2023 года социальной сети Дзен](https://dzen.ru/a/ZYWi7bChZQJnLS9d)
[^3]: [Итоги 2020 года социальной сети Яндекс.Дзен](https://themedia.center/yandex-zen-2020/)
[^4]: [Итоги 2021 года социальной сети Яндекс.Дзен](https://yandex.ru/company/news/2021-12-27)
[^5]: [Итоги 2022 года социальной сети Яндекс.Дзен](https://www.cnews.ru/news/line/2022-12-23_dzen_podvel_itogi_2022_goda)
[^6]: [Доклад Ивана Емельянова на Highload 2022](https://highload.ru/moscow/2022/abstracts/9570)
[^7]: [Статистика Дзена №1](https://inclient.ru/dzen-stats/)
[^8]: [Статистика Дзена №2](https://alente.ru/blog/yandeksdzen-kak-platforma-dlya-formirovaniya-interesa-k-produktuusluge)
[^9]: [Поддомены Дзена](https://dnsdumpster.com/)
[^10]:[лекция 4](https://cloud.mail.ru/public/xmoU/e4DhrLWzT)
[^11]:[k8s service and endpoints](https://kubernetes.io/docs/concepts/services-networking/service/)
